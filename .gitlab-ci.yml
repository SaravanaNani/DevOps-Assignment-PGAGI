stages:
  - validate
  - plan
  - apply
  - destroy
  - build
  - deploy

#################################################
# FORCE MANUAL PIPELINE TRIGGER
#################################################

workflow:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web"'
    - when: never

#################################################
# REQUIRED INPUT VARIABLES
#################################################

variables:
  CLOUD:
    description: "Select Cloud Provider"
  ENVIRONMENT:
    description: "Select Environment (dev/staging/prod)"
  ACTION:
    description: "infra or deploy"

#################################################
# BEFORE SCRIPT (PATH VALIDATION)
#################################################

.before_terraform:
  image:
    name: hashicorp/terraform:1.6
    entrypoint: [""]
  before_script:
    - export TF_ROOT="Infra/${CLOUD}/environments/${ENVIRONMENT}"
    - echo "Selected Cloud: $CLOUD"
    - echo "Selected Environment: $ENVIRONMENT"
    - echo "Terraform Root Path: $TF_ROOT"
    - |
      if [ ! -d "$TF_ROOT" ]; then
        echo "ERROR: Path $TF_ROOT does not exist"
        exit 1
      fi

#################################################
# TERRAFORM VALIDATE
#################################################

terraform_validate:
  stage: validate
  extends: .before_terraform
  script:
    - cd $TF_ROOT
    - terraform init -backend=false
    - terraform validate
  rules:
    - if: '$ACTION == "infra"'

#################################################
# TERRAFORM PLAN
#################################################

terraform_plan:
  stage: plan
  extends: .before_terraform
  script:
    - cd $TF_ROOT
    - terraform init
    - terraform plan -out=tfplan
  artifacts:
    paths:
      - $TF_ROOT/tfplan
  rules:
    - if: '$ACTION == "infra"'

#################################################
# TERRAFORM APPLY
#################################################

terraform_apply:
  stage: apply
  extends: .before_terraform
  script:
    - cd $TF_ROOT
    - terraform apply tfplan
  when: manual
  rules:
    - if: '$ACTION == "infra"'

#################################################
# TERRAFORM DESTROY
#################################################

terraform_destroy:
  stage: destroy
  extends: .before_terraform
  script:
    - cd $TF_ROOT
    - terraform destroy -auto-approve
  when: manual
  rules:
    - if: '$ACTION == "infra"'

#################################################
# BUILD DOCKER IMAGES
#################################################

build_images:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  script:
    - docker build -t saravana2002/pgagi-backend:$CI_COMMIT_SHORT_SHA ./backend
    - docker build -t saravana2002/pgagi-frontend:$CI_COMMIT_SHORT_SHA ./frontend
    - docker login -u $DOCKER_USER -p $DOCKER_PASS
    - docker push saravana2002/pgagi-backend:$CI_COMMIT_SHORT_SHA
    - docker push saravana2002/pgagi-frontend:$CI_COMMIT_SHORT_SHA
  rules:
    - if: '$ACTION == "deploy"'

#################################################
# DEPLOY TO AWS (ECS)
#################################################

deploy_aws:
  stage: deploy
  image: amazon/aws-cli
  script:
    - aws ecs update-service --cluster pgagi-$ENVIRONMENT-cluster --service pgagi-$ENVIRONMENT-backend-svc --force-new-deployment
    - aws ecs update-service --cluster pgagi-$ENVIRONMENT-cluster --service pgagi-$ENVIRONMENT-frontend-svc --force-new-deployment
  rules:
    - if: '$CLOUD == "aws" && $ACTION == "deploy"'

#################################################
# DEPLOY TO GCP (MIG Rolling Restart)
#################################################

deploy_gcp:
  stage: deploy
  image: google/cloud-sdk:latest
  script:
    - echo "$GCP_SA_KEY" > key.json
    - gcloud auth activate-service-account --key-file=key.json
    - gcloud config set project $GCP_PROJECT_ID
    - gcloud compute instance-groups managed rolling-action restart pgagi-$ENVIRONMENT-backend-mig --zone asia-south1-a
    - gcloud compute instance-groups managed rolling-action restart pgagi-$ENVIRONMENT-frontend-mig --zone asia-south1-a
  rules:
    - if: '$CLOUD == "gcp" && $ACTION == "deploy"'